# Система рассылок ПростоБюро

## Описание
Полноценная система управления email рассылками с возможностью:
- Создания и редактирования кампаний
- Планирования отправки
- Отслеживания статистики
- Управления подписчиками

## Структура системы

### API Endpoints
- `POST /api/newsletter/campaigns` - создание кампании
- `GET /api/newsletter/campaigns` - получение списка кампаний
- `GET /api/newsletter/campaigns/[id]` - получение конкретной кампании
- `PUT /api/newsletter/campaigns/[id]` - обновление кампании
- `DELETE /api/newsletter/campaigns/[id]` - удаление кампании
- `POST /api/newsletter/campaigns/[id]/send` - отправка кампании
- `POST /api/newsletter/scheduled` - обработка запланированных рассылок (для cron)

### Админ панель
- `/admin/newsletter` - управление подписчиками
- `/admin/newsletter/campaigns` - список кампаний
- `/admin/newsletter/campaigns/new` - создание новой кампании
- `/admin/newsletter/campaigns/[id]/edit` - редактирование кампании

### База данных
Созданы следующие таблицы:
- `newsletter_subscribers` - подписчики
- `newsletter_campaigns` - кампании рассылок
- `newsletter_logs` - логи отправки писем

## Настройка

### 1. Обновление базы данных
Выполните SQL скрипт `create-supabase-tables.sql` в панели Supabase:
```sql
-- Скрипт создаст все необходимые таблицы, индексы и функции
```

### 2. Переменные окружения
Добавьте в `.env.local`:
```
CRON_SECRET=your-secret-key-for-cron-jobs
```

### 3. Настройка email сервиса
Для отправки реальных писем необходимо интегрировать email сервис:

#### Варианты интеграции:
1. **SendGrid** - рекомендуется
2. **Mailgun** 
3. **Amazon SES**
4. **Nodemailer с SMTP**

#### Пример интеграции с SendGrid:
```bash
npm install @sendgrid/mail
```

Обновите файлы отправки писем:
- `app/api/newsletter/campaigns/[id]/send/route.ts`
- `app/api/newsletter/scheduled/route.ts`

```typescript
import sgMail from '@sendgrid/mail'

sgMail.setApiKey(process.env.SENDGRID_API_KEY!)

// Замените console.log на реальную отправку:
const msg = {
  to: subscriber.email,
  from: 'noreply@prostoburo.ru',
  subject: campaign.subject,
  text: campaign.content,
  html: `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
    <h2>${campaign.subject}</h2>
    <div style="white-space: pre-wrap;">${campaign.content}</div>
    <hr style="margin: 20px 0;">
    <p style="color: #666; font-size: 12px;">
      Вы получили это письмо, потому что подписались на рассылку ПростоБюро.
      <br>
      <a href="mailto:info@prostoburo.ru">Отписаться от рассылки</a>
    </p>
  </div>`
}

await sgMail.send(msg)
```

### 4. Автоматическая отправка запланированных рассылок

#### Вариант 1: Vercel Cron Jobs
Создайте файл `vercel.json`:
```json
{
  "crons": [
    {
      "path": "/api/newsletter/scheduled",
      "schedule": "0 */6 * * *"
    }
  ]
}
```

#### Вариант 2: Внешний cron сервис
Настройте внешний cron (например, cron-job.org) для вызова:
```
POST https://your-domain.com/api/newsletter/scheduled
Authorization: Bearer your-cron-secret
```

## Использование

### Создание рассылки
1. Перейдите в админ панель: `/admin/newsletter/campaigns`
2. Нажмите "Создать кампанию"
3. Заполните тему и содержание
4. Выберите время отправки (или оставьте пустым для черновика)
5. Сохраните кампанию

### Отправка рассылки
1. В списке кампаний нажмите "Отправить"
2. Подтвердите отправку
3. Система отправит письма всем активным подписчикам
4. Результаты будут сохранены в логах

### Планирование рассылки
1. При создании кампании укажите дату и время в поле "Запланировать отправку"
2. Кампания получит статус "Запланирована"
3. Система автоматически отправит её в указанное время

## Мониторинг

### Статистика
- Количество подписчиков (всего/активных/за месяц)
- Количество кампаний
- Статистика отправки (доставлено/ошибки)

### Логи
Все отправки сохраняются в таблице `newsletter_logs` с информацией:
- Email получателя
- Статус отправки
- Время отправки
- Сообщение об ошибке (если есть)

## Рекомендации

### Частота рассылок
- Новости: 1-2 раза в неделю
- Промо-акции: не чаще 1 раза в неделю
- Важные уведомления: по мере необходимости

### Содержание писем
- Краткие и информативные заголовки
- Структурированный контент
- Призыв к действию
- Контактная информация

### Соблюдение законодательства
- Возможность отписки в каждом письме
- Согласие на обработку персональных данных
- Соблюдение требований 152-ФЗ

## Безопасность

### Защита API
- Авторизация через сервисную роль Supabase
- Секретный ключ для cron jobs
- Row Level Security в базе данных

### Защита от спама
- Валидация email адресов
- Ограничение частоты отправки
- Мониторинг bounce rate

## Масштабирование

### При росте базы подписчиков
- Используйте очереди для обработки больших рассылок
- Реализуйте батчевую отправку
- Добавьте rate limiting

### Аналитика
- Отслеживание открытий писем
- Клики по ссылкам
- Конверсия подписчиков

## Поддержка
При возникновении проблем проверьте:
1. Логи в консоли браузера
2. Логи сервера в Vercel
3. Статус таблиц в Supabase
4. Настройки email сервиса 